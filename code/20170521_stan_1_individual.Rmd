---
title: "Stan analysis 1 - Single subject"
author: "Kenta Yoshida"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

# Setup and load data
```{r setup, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(rstan)

rstan_options(auto_write=T)
options(mc.cores=parallel::detectCores())

data.pk   <- read_csv("../data/sim_pk_20170521.csv") 
data.subj <- read_csv("../data/subj_dose_20170521.csv") 
```

# Data quick look

```{r}
data.pk %>%
  filter(ID==1) %>% 
  ggplot(aes(TIME, CONC)) +
  geom_line() +
  geom_point() 

full_join(data.pk, data.subj) %>% 
  ggplot(aes(TIME, CONC, group=ID)) +
  geom_line() +
  geom_point() +
  facet_wrap(~DOSE) +
  scale_y_log10()

```


# Only sigma

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC,
       KA = 0.3,
       CL = 0.303,
       VD = 4.91,
       
       N_new = nrow(data.pk.id1),
       TIME_new = data.pk.id1$TIME)

fit.stan <-
  stan(file = "mod_00_single_subj_onlySigma.stan", data = data)
fit.stan

```

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggmcmc::ggmcmc(ggs(fit.stan), file="../mod_fit_ggmcmc/mod_00_single_subj_onlySigma.pdf")
```

## Prediction vs Observed

```{r plot pred vs obs}
mcmc.sample <- rstan::extract(fit.stan)

y.pred.interval <- 
  mcmc.sample$y_new %>% 
  apply(MARGIN=2, quantile, prob=c(0.05, 0.5, 0.95)) %>% 
  t() %>% 
  tbl_df()

bind_cols(data.pk.id1,
          y.pred.interval) %>% 
  ggplot(aes(TIME, `50%`)) +
  geom_line() +
  geom_ribbon(aes(ymin=`5%`, ymax=`95%`),alpha=0.1) +
  geom_point(data=data.pk.id1, aes(TIME,CONC))

```


# Except ka

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC,
       KA   = 0.3,
       
       N_new = nrow(data.pk.id1),
       TIME_new = data.pk.id1$TIME)

fit.stan <-
  stan(file = "mod_00_single_subj.stan", data = data)

fit.stan

```

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggmcmc::ggmcmc(ggs(fit.stan), file="../mod_fit_ggmcmc/mod_00_single_subj.pdf")
```

## Prediction vs Observed

```{r ref.label="plot pred vs obs"}
```



# Strong prior for ka

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC)

fit.stan <-
  stan(file = "mod_00_single_subj_with_ka.stan", data = data)

fit.stan
```

## See how ka change with more data

```{r}
data.pk.id1.2 <- 
  bind_rows(data.pk.id1, data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1)

data2 <- 
  list(N    = nrow(data.pk.id1.2),
       TIME = data.pk.id1.2$TIME,
       DOSE = 10,
       Y    = data.pk.id1.2$CONC)

fit.stan2 <-
  stan("mod_00_single_subj_with_ka.stan", data=data2, seed=1)

fit.stan2
```

## Prediction vs Observed

```{r ref.label="plot pred vs obs"}
```


# Weak prior for all parameters

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC)

fit.stan <-
  stan(file = "mod_00_single_subj_weakPrior.stan", data = data)

fit.stan
```

## See how ka change with more data

```{r}
data.pk.id1.2 <- 
  bind_rows(data.pk.id1, data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1)

data2 <- 
  list(N    = nrow(data.pk.id1.2),
       TIME = data.pk.id1.2$TIME,
       DOSE = 10,
       Y    = data.pk.id1.2$CONC)

fit.stan2 <-
  stan("mod_00_single_subj_with_ka.stan", data=data2, seed=1)

fit.stan2
```

## Prediction vs Observed

```{r ref.label="plot pred vs obs"}
```


# Limit Vd

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC)

fit.stan <-
  stan(file = "mod_00_single_subj_limVd.stan", data = data)

fit.stan
```

## Prediction vs Observed

```{r ref.label="plot pred vs obs"}
```


# Ordered parameter for KA and KEL

Doesn't really work - kel go too large  
Probably need some way to constraint parameter range with prior; otherwise initial sampling inflates K[1] and K[2] difference

```{r}
data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC)

fit.stan <-
  stan(file = "mod_00_single_subj_ordered.stan", data = data)

fit.stan
```



