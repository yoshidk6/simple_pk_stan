---
title: "Stan analysis 1 - simple"
author: "Kenta Yoshida"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_float: true
    theme: cosmo
    code_folding: hide
---

```{r setup, include=FALSE,warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE)
library(tidyverse)
library(rstan)
library(ggmcmc)

#rstan_options(auto_write=T)
#options(mc.cores=parallel::detectCores())
```

# Data import and quick look

```{r, message=FALSE, warning=FALSE}
data.pk   <- read_csv("data/sim_pk_20170521.csv") 
data.subj <- read_csv("data/subj_dose_20170521.csv") 

full_join(data.pk, data.subj) %>% 
  ggplot(aes(TIME, CONC, group=ID)) +
  geom_line() +
  geom_point() +
  facet_wrap(~DOSE) +
  scale_y_log10()

```


# Single subject - Estimate only sigma

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
mod_00_single_subj_onlySigma <- stan_model(file="mod_00_single_subj_onlySigma.stan")

data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC,
       KA = 0.3,
       CL = 0.27,
       VD = 4.2,
       
       N_new = nrow(data.pk.id1),
       TIME_new = data.pk.id1$TIME)

fit.stan <-
  sampling(mod_00_single_subj_onlySigma, data=data, seed=1)

fit.stan

#ggmcmc(ggs(fit.stan), file="mod_fit_ggmcmc/mod_00_single_subj_onlySigma.pdf")
```


## Prediction vs Observed

```{r, message=FALSE, warning=FALSE}
mcmc.sample <- rstan::extract(fit.stan)

y.pred.interval <- 
  mcmc.sample$y_new %>% 
  apply(MARGIN=2,quantile, prob=c(0.1, 0.5, 0.9)) %>% 
  t() %>% 
  tbl_df()

bind_cols(data.pk.id1,
          y.pred.interval) %>% 
  mutate(ID=as.factor(ID)) %>% 
  ggplot(aes(TIME, `50%`, color=ID)) +
  #facet_wrap(~ID) +
  geom_line() +
  geom_ribbon(aes(ymin=`10%`, ymax=`90%`, fill=ID),alpha=0.1) +
  geom_point(data=data.pk.id1 %>% mutate(ID=as.factor(ID)),
             aes(TIME,CONC))

```


# Single subject - Estimate parameters except ka

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
mod_00_single_subj <- stan_model(file="mod_00_single_subj.stan")

data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC,
       KA   = 0.3,
       
       N_new = nrow(data.pk.id1),
       TIME_new = data.pk.id1$TIME)

fit.stan <-
  sampling(mod_00_single_subj, data=data, seed=1)

fit.stan

#ggmcmc(ggs(fit.stan), file="mod_fit_ggmcmc/mod_00_single_subj_onlySigma.pdf")
```


## Prediction vs Observed

```{r, message=FALSE, warning=FALSE}
mcmc.sample <- rstan::extract(fit.stan)

y.pred.interval <- 
  mcmc.sample$y_new %>% 
  apply(MARGIN=2,quantile, prob=c(0.1, 0.5, 0.9)) %>% 
  t() %>% 
  tbl_df()

bind_cols(data.pk.id1,
          y.pred.interval) %>% 
  mutate(ID=as.factor(ID)) %>% 
  ggplot(aes(TIME, `50%`, color=ID)) +
  #facet_wrap(~ID) +
  geom_line() +
  geom_ribbon(aes(ymin=`10%`, ymax=`90%`, fill=ID),alpha=0.1) +
  geom_point(data=data.pk.id1 %>% mutate(ID=as.factor(ID)),
             aes(TIME,CONC))

```



# Single subject - Estimate parameters including ka

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
mod_00_single_subj_with_ka <- stan_model(file="mod_00_single_subj_with_ka.stan")

data.pk.id1 <- data.pk %>% filter(ID==1)

data <- 
  list(N    = nrow(data.pk.id1),
       TIME = data.pk.id1$TIME,
       DOSE = 10,
       Y    = data.pk.id1$CONC,
       
       N_new = nrow(data.pk.id1),
       TIME_new = data.pk.id1$TIME)

fit.stan <-
  sampling(mod_00_single_subj_with_ka, data=data, seed=1)

fit.stan
```

## See how ka change with more data

```{r, message=FALSE, warning=FALSE}
data.pk.id1.2 <- 
  bind_rows(data.pk.id1, data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1) %>% 
  bind_rows(data.pk.id1)

data2 <- 
  list(N    = nrow(data.pk.id1.2),
       TIME = data.pk.id1.2$TIME,
       DOSE = 10,
       Y    = data.pk.id1.2$CONC,
       
       N_new = nrow(data.pk.id1.2),
       TIME_new = data.pk.id1.2$TIME)

fit.stan2 <-
  sampling(mod_00_single_subj_with_ka, data=data2, seed=1)

fit.stan2

#ggmcmc(ggs(fit.stan), file="mod_fit_ggmcmc/mod_00_single_subj_onlySigma.pdf")
```


## Prediction vs Observed

```{r, message=FALSE, warning=FALSE}
mcmc.sample <- rstan::extract(fit.stan)

y.pred.interval <- 
  mcmc.sample$y_new %>% 
  apply(MARGIN=2,quantile, prob=c(0.1, 0.5, 0.9)) %>% 
  t() %>% 
  tbl_df()

bind_cols(data.pk.id1,
          y.pred.interval) %>% 
  mutate(ID=as.factor(ID)) %>% 
  ggplot(aes(TIME, `50%`, color=ID)) +
  #facet_wrap(~ID) +
  geom_line() +
  geom_ribbon(aes(ymin=`10%`, ymax=`90%`, fill=ID),alpha=0.1) +
  geom_point(data=data.pk.id1 %>% mutate(ID=as.factor(ID)),
             aes(TIME,CONC))

```










# Without IIV on parameters

```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
mod_01_noIIV <- stan_model(file="mod_01_noIIV.stan")
save(mod_01_noIIV, file="mod_compiled/mod_01_noIIV.Rdata")
```

## Fit with `rstan`

```{r}
load(file="mod_compiled/mod_01_noIIV.Rdata")

data <- 
  list(N    = nrow(data.pk),
       N_ID = nrow(data.subj),
       ID   = data.pk$ID,
       TIME = data.pk$TIME,
       DOSE = data.subj$DOSE,
       Y    = data.pk$CONC)

fit.stan <-
  sampling(mod_01_noIIV, data=data, seed=1)

fit.stan
```

# MCMC convergence

```{r, message=FALSE, warning=FALSE}
summary(fit.stan)$summary
```

## Export
Turned off  
```{r, eval=FALSE, message=FALSE, warning=FALSE, include=FALSE}
ggmcmc(ggs(fit.stan, inc_warmup = T, stan_include_auxiliar = T),
       file="ch04_stan_fit_trace.pdf", plot="traceplot")
ggmcmc(ggs(fit.stan), file="ch04_stan_fit.pdf")
```


# Bayes confidence and prediction interval
## Extract parameters

```{r, message=FALSE, warning=FALSE}
mcmc.sample <- rstan::extract(fit.stan)

print("Prediction interval for the parameter b")
quantile(mcmc.sample$b, probs=c(0.025,0.975))

mcmc.sample.df <- 
  data.frame(a = mcmc.sample$a,
             b = mcmc.sample$b,
             sigma = mcmc.sample$sigma) %>% 
  tbl_df()

ggplot(mcmc.sample.df,aes(a,b)) +
  geom_point()
```


## Calculate intervals

```{r, message=FALSE, warning=FALSE}
x.new <- 21:60
n.mcmc <- nrow(mcmc.sample.df)

a <- mcmc.sample.df$a
b <- mcmc.sample.df$b
sigma <- mcmc.sample.df$sigma

y.base.mcmc <- matrix(nrow=n.mcmc, ncol=length(x.new))
y.mcmc      <- matrix(nrow=n.mcmc, ncol=length(x.new))

set.seed(1)
# Prepare matrices for y.base.mcmc and y.mcmc 
for(k in 1:length(x.new)){
  y.base = a + b*x.new[k]
  y = rnorm(n   = n.mcmc, 
            mean= y.base, 
            sd  = sigma)
  # Ref on rnorm: 
  # http://stackoverflow.com/questions/3510619/calling-rnorm-with-a-vector-of-means
  
  y.base.mcmc[,k] <- y.base
  y.mcmc[,k]      <- y
}
```


## Plot Bayes confidence interval
The ranges for CI reflect uncertainly in estimated parameters (`eta`). Different set of parameters from MCMC samples were used for calculation of CI  


```{r, message=FALSE, warning=FALSE}
data.frame.quantile.mcmc(x=x.new, y_mcmc=y.base.mcmc) %>% 
  ggplot.5quantile() +
  geom_point(data=data.salary, aes(x=X, y=Y), shape=1, size=3) +
  labs(x='X', y='Y') + 
  scale_y_continuous(breaks=seq(from=200, to=1400, by=400)) +
  coord_cartesian(xlim=c(22, 61), ylim=c(200, 1400))
```


## Plot Bayes prediction interval
The ranges for PI reflect parameter uncertainty (`eta`) plus random variability (`eps`)  

```{r, message=FALSE, warning=FALSE}
data.frame.quantile.mcmc(x=x.new, y_mcmc=y.mcmc) %>% 
  ggplot.5quantile() +
  geom_point(data=data.salary, aes(x=X, y=Y), shape=1, size=3)+
  labs(x='X', y='Y') + 
  scale_y_continuous(breaks=seq(from=200, to=1400, by=400)) +
  coord_cartesian(xlim=c(22, 61), ylim=c(200, 1400))
```




